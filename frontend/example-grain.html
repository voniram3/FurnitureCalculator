<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cut List Optimizer - –° Grain Direction</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }
        
        h1 { color: #667eea; margin-bottom: 10px; }
        h2 { color: #764ba2; margin: 30px 0 15px 0; }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        input, select {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-danger { background: #dc3545; }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .grain-info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .grain-info h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .results-container {
            margin-top: 30px;
        }
        
        .sheet-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .cutlist-svg {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            max-width: 100%;
            height: auto;
        }
        
        .cutlist-part {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .cutlist-part:hover {
            opacity: 0.9;
            stroke-width: 3 !important;
        }
        
        .cutlist-part.grain-violation {
            filter: drop-shadow(0 0 3px rgba(220, 53, 69, 0.8));
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #495057;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .report-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .report-table td:first-child {
            font-weight: bold;
            color: #495057;
            width: 50%;
        }
        
        .grain-warning {
            background: #f8d7da !important;
            color: #721c24;
        }
        
        .grain-ok {
            background: #d4edda !important;
            color: #155724;
        }
        
        .grain-violation-row {
            background: #fff3cd;
        }
        
        .parts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .parts-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
        }
        
        .parts-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .cutting-instructions {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .cut-sequence {
            list-style-position: inside;
        }
        
        .cut-sequence li {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
        }
        
        .rotated-indicator {
            color: #ffc107;
            font-weight: bold;
        }
        
        .grain-warning-inline {
            color: #dc3545;
            font-weight: bold;
        }
        
        .grain-notice {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü™ö Cut List Optimizer v3.0</h1>
        <p style="color: #6c757d; margin-bottom: 20px;">–ü—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ —Ä–∞–∑–∫—Ä–æ–π —Å –ø–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ grain direction</p>
        
        <div class="grain-info">
            <h4>üåæ –ö–∞–∫–≤–æ –µ Grain Direction (–§–ª–∞–¥–µ—Ä)?</h4>
            <p><strong>Grain direction</strong> –µ –ø–æ—Å–æ–∫–∞—Ç–∞ –Ω–∞ –≤–ª–∞–∫–Ω–∞—Ç–∞ –≤ –¥—ä—Ä–≤–µ—Å–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª. –ü—Ä–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏ –∫–∞—Ç–æ –•–î–õ, —Ñ—É—Ä–Ω–∏—Ä –∏ –º–∞—Å–∏–≤, grain-—ä—Ç –≤–∏–Ω–∞–≥–∏ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –≤ –µ–¥–Ω–∞ –ø–æ—Å–æ–∫–∞ –∑–∞ –µ—Å—Ç–µ—Ç–∏—á–µ–Ω –≤–∏–¥.</p>
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li><strong>Horizontal (‚Üí)</strong> - –í–ª–∞–∫–Ω–∞—Ç–∞ —Å–∞ —Ö–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–Ω–∏</li>
                <li><strong>Vertical (‚Üë)</strong> - –í–ª–∞–∫–Ω–∞—Ç–∞ —Å–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª–Ω–∏</li>
                <li><strong>Any</strong> - –ë–µ–∑ –∑–Ω–∞—á–µ–Ω–∏–µ (–ü–î–ß, –ú–î–§)</li>
            </ul>
        </div>
        
        <div class="controls">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            
            <div class="checkbox-group">
                <input type="checkbox" id="allowRotation" checked>
                <label for="allowRotation">–ü–æ–∑–≤–æ–ª–∏ –∑–∞–≤—ä—Ä—Ç–∞–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∏</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="respectGrain" checked>
                <label for="respectGrain">üåæ –£–≤–∞–∂–∞–≤–∞–π grain direction</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="showGrain" checked>
                <label for="showGrain">–ü–æ–∫–∞–∂–∏ grain visualization</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="showGrainViolations" checked>
                <label for="showGrainViolations">‚ö† –ú–∞—Ä–∫–∏—Ä–∞–π grain –Ω–∞—Ä—É—à–µ–Ω–∏—è</label>
            </div>
        </div>
        
        <div class="controls">
            <h2>–î–æ–±–∞–≤–∏ –î–µ—Ç–∞–π–ª</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>–ò–º–µ</label>
                    <input type="text" id="partName" placeholder="–°—Ç—Ä–∞–Ω–∏—Ü–∞" value="–°—Ç—Ä–∞–Ω–∏—Ü–∞">
                </div>
                <div class="form-group">
                    <label>–®–∏—Ä–∏–Ω–∞ (mm)</label>
                    <input type="number" id="partWidth" value="760">
                </div>
                <div class="form-group">
                    <label>–í–∏—Å–æ—á–∏–Ω–∞ (mm)</label>
                    <input type="number" id="partHeight" value="560">
                </div>
                <div class="form-group">
                    <label>–ë—Ä–æ–π</label>
                    <input type="number" id="partQty" value="2" min="1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                    <select id="partMaterial">
                        <option value="–ü–î–ß 18–º–º">–ü–î–ß 18–º–º</option>
                        <option value="–ú–î–§ 18–º–º">–ú–î–§ 18–º–º</option>
                        <option value="–•–î–õ 18–º–º" selected>–•–î–õ 18–º–º</option>
                        <option value="–ú–∞—Å–∏–≤ 20–º–º">–ú–∞—Å–∏–≤ 20–º–º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üåæ Grain Direction</label>
                    <select id="partGrain">
                        <option value="auto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</option>
                        <option value="horizontal">Horizontal ‚Üí</option>
                        <option value="vertical">Vertical ‚Üë</option>
                        <option value="any">Any (–±–µ–∑ –∑–Ω–∞—á–µ–Ω–∏–µ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-10)</label>
                    <input type="number" id="partPriority" value="5" min="1" max="10">
                </div>
            </div>
            <button class="btn btn-success" onclick="addPart()">‚ûï –î–æ–±–∞–≤–∏ –î–µ—Ç–∞–π–ª</button>
            <div id="partsList" style="margin-top: 15px;"></div>
        </div>
        
        <div class="controls">
            <h2>–î–æ–±–∞–≤–∏ –õ–∏—Å—Ç</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>–ò–º–µ</label>
                    <input type="text" id="sheetName" value="–•–î–õ –õ–∏—Å—Ç">
                </div>
                <div class="form-group">
                    <label>–®–∏—Ä–∏–Ω–∞ (mm)</label>
                    <input type="number" id="sheetWidth" value="2800">
                </div>
                <div class="form-group">
                    <label>–í–∏—Å–æ—á–∏–Ω–∞ (mm)</label>
                    <input type="number" id="sheetHeight" value="2070">
                </div>
                <div class="form-group">
                    <label>–¶–µ–Ω–∞ (–ª–≤)</label>
                    <input type="number" id="sheetCost" value="250" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                    <select id="sheetMaterial">
                        <option value="–ü–î–ß 18–º–º">–ü–î–ß 18–º–º</option>
                        <option value="–ú–î–§ 18–º–º">–ú–î–§ 18–º–º</option>
                        <option value="–•–î–õ 18–º–º" selected>–•–î–õ 18–º–º</option>
                        <option value="–ú–∞—Å–∏–≤ 20–º–º">–ú–∞—Å–∏–≤ 20–º–º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üåæ Grain Direction</label>
                    <select id="sheetGrain">
                        <option value="auto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</option>
                        <option value="horizontal" selected>Horizontal ‚Üí</option>
                        <option value="vertical">Vertical ‚Üë</option>
                        <option value="any">Any (–±–µ–∑ –∑–Ω–∞—á–µ–Ω–∏–µ)</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-success" onclick="addSheet()">‚ûï –î–æ–±–∞–≤–∏ –õ–∏—Å—Ç</button>
            <div id="sheetsList" style="margin-top: 15px;"></div>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="calculate()" style="font-size: 1.2em; padding: 15px 40px;">
                üßÆ –ò–∑—á–∏—Å–ª–∏ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
            </button>
            <button class="btn btn-warning" onclick="loadExample()">
                üìù –ó–∞—Ä–µ–¥–∏ –ü—Ä–∏–º–µ—Ä
            </button>
            <button class="btn btn-danger" onclick="clearAll()">
                üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏ –í—Å–∏—á–∫–æ
            </button>
        </div>
        
        <div id="results" class="results-container"></div>
    </div>
    
    <script type="module">
        import { CutListEngine } from './engine-improved.js';
        import { CutListVisualizer } from './visualizer-improved.js';
        
        window.engine = new CutListEngine();
        
        window.updateSettings = () => {
            engine.settings.allowRotation = document.getElementById('allowRotation').checked;
            engine.settings.respectGrainDirection = document.getElementById('respectGrain').checked;
        };
        
        window.addPart = () => {
            updateSettings();
            const name = document.getElementById('partName').value;
            const width = parseInt(document.getElementById('partWidth').value);
            const height = parseInt(document.getElementById('partHeight').value);
            const qty = parseInt(document.getElementById('partQty').value);
            const material = document.getElementById('partMaterial').value;
            const grainValue = document.getElementById('partGrain').value;
            const priority = parseInt(document.getElementById('partPriority').value);
            
            const grainDirection = grainValue === 'auto' 
                ? engine.detectGrainDirection(material, width, height)
                : grainValue;
            
            engine.addPart(name, width, height, qty, material, {
                grainDirection,
                priority
            });
            
            updatePartsList();
        };
        
        window.addSheet = () => {
            const name = document.getElementById('sheetName').value;
            const width = parseInt(document.getElementById('sheetWidth').value);
            const height = parseInt(document.getElementById('sheetHeight').value);
            const cost = parseFloat(document.getElementById('sheetCost').value);
            const material = document.getElementById('sheetMaterial').value;
            const grainValue = document.getElementById('sheetGrain').value;
            
            const grainDirection = grainValue === 'auto'
                ? engine.detectGrainDirection(material, width, height)
                : grainValue;
            
            engine.addSheet(name, width, height, cost, material, { grainDirection });
            updateSheetsList();
        };
        
        window.calculate = () => {
            updateSettings();
            const results = engine.calculateOptimization();
            displayResults(results);
        };
        
        window.loadExample = () => {
            engine.parts = [];
            engine.sheets = [];
            
            // –î–æ–±–∞–≤—è–º–µ –ª–∏—Å—Ç–æ–≤–µ —Å grain
            engine.addSheet('–•–î–õ –õ–∏—Å—Ç 1', 2800, 2070, 250, '–•–î–õ 18–º–º', { grainDirection: 'horizontal' });
            
            // –î–æ–±–∞–≤—è–º–µ –¥–µ—Ç–∞–π–ª–∏ —Å grain
            engine.addPart('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —à–∫–∞—Ñ', 760, 560, 2, '–•–î–õ 18–º–º', { grainDirection: 'horizontal', priority: 8 });
            engine.addPart('–†–∞—Ñ—Ç', 580, 500, 3, '–•–î–õ 18–º–º', { grainDirection: 'horizontal', priority: 6 });
            engine.addPart('–í—Ä–∞—Ç–∞', 697, 560, 2, '–•–î–õ 18–º–º', { grainDirection: 'vertical', priority: 9 });
            engine.addPart('–î—ä–Ω–æ', 582, 500, 1, '–•–î–õ 18–º–º', { grainDirection: 'horizontal', priority: 5 });
            
            updatePartsList();
            updateSheetsList();
            alert('‚úÖ –ü—Ä–∏–º–µ—Ä–µ–Ω –ø—Ä–æ–µ–∫—Ç –∑–∞—Ä–µ–¥–µ–Ω! –ö–ª–∏–∫–Ω–µ—Ç–µ "–ò–∑—á–∏—Å–ª–∏ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è"');
        };
        
        window.clearAll = () => {
            if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ?')) {
                engine.parts = [];
                engine.sheets = [];
                engine.results = [];
                updatePartsList();
                updateSheetsList();
                document.getElementById('results').innerHTML = '';
            }
        };
        
        function updatePartsList() {
            const container = document.getElementById('partsList');
            if (engine.parts.length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –¥–µ—Ç–∞–π–ª–∏</p>';
                return;
            }
            
            let html = '<h4>–î–æ–±–∞–≤–µ–Ω–∏ –¥–µ—Ç–∞–π–ª–∏ (' + engine.parts.length + '):</h4><ul style="list-style: none; padding: 0;">';
            
            // Group by name
            const grouped = {};
            engine.parts.forEach(p => {
                const key = `${p.name}_${p.width}x${p.height}_${p.grainDirection}`;
                if (!grouped[key]) grouped[key] = { ...p, count: 0 };
                grouped[key].count++;
            });
            
            Object.values(grouped).forEach(p => {
                const grainIcon = p.grainDirection === 'horizontal' ? '‚Üí' : 
                                 (p.grainDirection === 'vertical' ? '‚Üë' : '‚óã');
                html += `<li style="padding: 5px; background: #f8f9fa; margin: 3px 0; border-radius: 3px;">
                    ${p.count}x ${p.name} (${p.width}√ó${p.height}mm) - ${p.material} ${grainIcon}
                </li>`;
            });
            
            html += '</ul>';
            container.innerHTML = html;
        }
        
        function updateSheetsList() {
            const container = document.getElementById('sheetsList');
            if (engine.sheets.length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –ª–∏—Å—Ç–æ–≤–µ</p>';
                return;
            }
            
            let html = '<h4>–î–æ–±–∞–≤–µ–Ω–∏ –ª–∏—Å—Ç–æ–≤–µ (' + engine.sheets.length + '):</h4><ul style="list-style: none; padding: 0;">';
            engine.sheets.forEach(s => {
                const grainIcon = s.grainDirection === 'horizontal' ? '‚Üí' : 
                                 (s.grainDirection === 'vertical' ? '‚Üë' : '‚óã');
                html += `<li style="padding: 5px; background: #f8f9fa; margin: 3px 0; border-radius: 3px;">
                    ${s.name} (${s.width}√ó${s.height}mm) - ${s.materialType} ${grainIcon} - ${s.cost}–ª–≤
                </li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
        }
        
        function displayResults(results) {
            const showGrain = document.getElementById('showGrain').checked;
            const showGrainViolations = document.getElementById('showGrainViolations').checked;
            
            const stats = engine.getStatistics();
            const container = document.getElementById('results');
            
            let html = '<h2>üìä –†–µ–∑—É–ª—Ç–∞—Ç–∏</h2>';
            
            // Statistics cards
            html += '<div class="stats-grid">';
            html += `<div class="stat-card">
                <div class="stat-label">–ò–∑–ø–æ–ª–∑–≤–∞–Ω–∏ –ª–∏—Å—Ç–æ–≤–µ</div>
                <div class="stat-value">${stats.totalSheets}</div>
            </div>`;
            html += `<div class="stat-card">
                <div class="stat-label">–ü–æ—Å—Ç–∞–≤–µ–Ω–∏ –¥–µ—Ç–∞–π–ª–∏</div>
                <div class="stat-value">${stats.placedParts}/${stats.totalParts}</div>
            </div>`;
            html += `<div class="stat-card">
                <div class="stat-label">–ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç</div>
                <div class="stat-value">${stats.materialEfficiency}</div>
            </div>`;
            html += `<div class="stat-card ${stats.grainViolations > 0 ? 'grain-warning' : 'grain-ok'}">
                <div class="stat-label">üåæ Grain –°—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
                <div class="stat-value">${stats.grainCompliance}</div>
            </div>`;
            html += '</div>';
            
            // Detailed report
            html += '<div id="detailedReport"></div>';
            
            // Visualization
            results.forEach((sheet, index) => {
                html += `<div class="sheet-container">
                    <div class="sheet-header">
                        <h3>–õ–∏—Å—Ç ${index + 1}: ${sheet.name}</h3>
                        <span>–ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç: ${sheet.efficiency.toFixed(1)}% | Grain: ${(sheet.grainCompliance || 100).toFixed(1)}%</span>
                    </div>
                    ${CutListVisualizer.generateSVG(sheet, { 
                        scale: 0.25, 
                        showGrain, 
                        showGrainViolations 
                    })}
                </div>`;
            });
            
            container.innerHTML = html;
            
            // Generate detailed report
            CutListVisualizer.generateReport(engine, 'detailedReport');
        }
    </script>
</body>
</html>
