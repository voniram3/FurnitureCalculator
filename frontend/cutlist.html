<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cut-list –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä - –ú–µ–±–µ–ª–µ–Ω –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* –î–æ–±–∞–≤–µ–Ω–∏ —Å—Ç–∏–ª–æ–≤–µ –∑–∞ grain */
        .grain-warning { background: #f8d7da; color: #721c24; }
        .grain-ok { background: #d4edda; color: #155724; }
        .grain-violation-row { background: #fff3cd; }
        .grain-notice { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .rotated-indicator { color: #ffc107; font-weight: bold; }
        .grain-warning-inline { color: #dc3545; font-weight: bold; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 5px; }
        .cutlist-part.grain-violation { filter: drop-shadow(0 0 3px rgba(220,53,69,0.8)); }
        /* –æ—Å—Ç–∞–Ω–∞–ª–∏—Ç–µ —Å—Ç–∏–ª–æ–≤–µ —Å–∞ —Å–∏ —Å—ä—â–∏—Ç–µ ‚Äì –∑–∞–ø–∞–∑–µ—Ç–µ –≥–∏ –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–Ω–∏—è cutlist.html */
    </style>
</head>
<body>
    <div class="cutlist-container">
        <header class="cutlist-header">
            <h1>‚úÇÔ∏è Cut-list –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä v3.0</h1>
            <p>–ü—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–æ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ —Å –ø–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ Grain Direction</p>
        </header>

        <div class="cutlist-grid">
            <!-- –õ—è–≤–∞ –∫–æ–ª–æ–Ω–∞: –í—ä–≤–µ–∂–¥–∞–Ω–µ -->
            <div class="input-section">
                <h3>1. –î–µ—Ç–∞–π–ª–∏ –∑–∞ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ</h3>
                <form id="partForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="partName">–ò–º–µ –Ω–∞ –¥–µ—Ç–∞–π–ª:</label>
                            <input type="text" id="partName" placeholder="–°—Ç—Ä–∞–Ω–∏—Ü–∞, –î—ä–Ω–æ, –†–∞—Ñ—Ç..." required>
                        </div>
                        <div class="form-group">
                            <label for="partWidth">–®–∏—Ä–æ—á–∏–Ω–∞ (mm):</label>
                            <input type="number" id="partWidth" min="10" value="500" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="partHeight">–í–∏—Å–æ—á–∏–Ω–∞ (mm):</label>
                            <input type="number" id="partHeight" min="10" value="700" required>
                        </div>
                        <div class="form-group">
                            <label for="partQuantity">–ë—Ä–æ–π:</label>
                            <input type="number" id="partQuantity" min="1" value="1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="partMaterial">–ú–∞—Ç–µ—Ä–∏–∞–ª:</label>
                            <select id="partMaterial">
                                <option value="–ü–î–ß 18–º–º">–ü–î–ß 18–º–º</option>
                                <option value="–ú–î–§ 18–º–º">–ú–î–§ 18–º–º</option>
                                <option value="–•–î–õ 18–º–º">–•–î–õ 18–º–º</option>
                                <option value="–ú–∞—Å–∏–≤ 20–º–º">–ú–∞—Å–∏–≤ 20–º–º</option>
                                <option value="–ì—Ä—ä–± –ü–î–ß 3–º–º">–ì—Ä—ä–± –ü–î–ß 3–º–º</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="partGrain">üåæ Grain direction:</label>
                            <select id="partGrain">
                                <option value="auto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</option>
                                <option value="horizontal">–•–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–µ–Ω ‚Üí</option>
                                <option value="vertical">–í–µ—Ä—Ç–∏–∫–∞–ª–µ–Ω ‚Üë</option>
                                <option value="any">–ë–µ–∑ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="partPriority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-10):</label>
                            <input type="number" id="partPriority" min="1" max="10" value="5">
                        </div>
                        <div class="form-group">
                            <label for="partAllowRotation">–ü–æ–∑–≤–æ–ª–∏ –∑–∞–≤—ä—Ä—Ç–∞–Ω–µ:</label>
                            <select id="partAllowRotation">
                                <option value="true">–î–∞</option>
                                <option value="false">–ù–µ</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏ –¥–µ—Ç–∞–π–ª</button>
                </form>

                <div class="parts-list" id="partsList">
                    <p style="color: #6c757d; text-align: center; padding: 20px;">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –¥–µ—Ç–∞–π–ª–∏</p>
                </div>

                <div class="settings-panel">
                    <h4>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è—Ç–∞</h4>
                    <div class="form-row">
                        <div class="checkbox-group">
                            <input type="checkbox" id="allowRotation" checked>
                            <label for="allowRotation">–ü–æ–∑–≤–æ–ª–∏ –∑–∞–≤—ä—Ä—Ç–∞–Ω–µ (–≥–ª–æ–±–∞–ª–Ω–æ)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="respectGrain" checked>
                            <label for="respectGrain">üåæ –£–≤–∞–∂–∞–≤–∞–π grain direction</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sortingMethod">–°–æ—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∏:</label>
                            <select id="sortingMethod">
                                <option value="area">–ü–æ –ø–ª–æ—â (–Ω–∞–π-–≥–æ–ª–µ–º–∏ –ø—ä—Ä–≤–∏)</option>
                                <option value="maxside">–ü–æ –Ω–∞–π-–¥—ä–ª–≥–∞ —Å—Ç—Ä–∞–Ω–∞</option>
                                <option value="width">–ü–æ —à–∏—Ä–æ—á–∏–Ω–∞</option>
                                <option value="height">–ü–æ –≤–∏—Å–æ—á–∏–Ω–∞</option>
                                <option value="grain">–ü–æ grain + –ø–ª–æ—â</option>
                                <option value="priority">–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="heuristic">–ï–≤—Ä–∏—Å—Ç–∏–∫–∞ –Ω–∞ –ø–æ—Å—Ç–∞–≤—è–Ω–µ:</label>
                            <select id="heuristic">
                                <option value="BAF">Best Area Fit</option>
                                <option value="BSSF">Best Short Side Fit</option>
                                <option value="BLSF">Best Long Side Fit</option>
                                <option value="guillotine">Guillotine (–∫–ª–∞—Å–∏—á–µ—Å–∫–∞)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bladeWidth">–î–µ–±–µ–ª–∏–Ω–∞ –Ω–∞ —Ä–µ–∂–µ—â–æ –æ—Å—Ç—Ä–∏–µ (mm):</label>
                            <input type="number" id="bladeWidth" min="0" max="10" step="0.5" value="4">
                        </div>
                        <div class="form-group">
                            <label for="minWaste">–ú–∏–Ω–∏–º–∞–ª–µ–Ω –æ—Ç–ø–∞–¥—ä–∫ (mm¬≤):</label>
                            <input type="number" id="minWaste" min="0" step="1000" value="10000">
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showGrainViz" checked>
                        <label for="showGrainViz">–ü–æ–∫–∞–∑–≤–∞–π grain –ª–∏–Ω–∏–∏ –≤—ä–≤ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è—Ç–∞</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showGrainWarnings" checked>
                        <label for="showGrainWarnings">‚ö† –ú–∞—Ä–∫–∏—Ä–∞–π grain –Ω–∞—Ä—É—à–µ–Ω–∏—è</label>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">2. –õ–∏—Å—Ç–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª</h3>
                <form id="sheetForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sheetWidth">–®–∏—Ä–æ—á–∏–Ω–∞ –Ω–∞ –ª–∏—Å—Ç (mm):</label>
                            <input type="number" id="sheetWidth" min="100" value="2070" required>
                        </div>
                        <div class="form-group">
                            <label for="sheetHeight">–í–∏—Å–æ—á–∏–Ω–∞ –Ω–∞ –ª–∏—Å—Ç (mm):</label>
                            <input type="number" id="sheetHeight" min="100" value="2800" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sheetCost">–¶–µ–Ω–∞ –Ω–∞ –ª–∏—Å—Ç (–ª–≤.):</label>
                            <input type="number" id="sheetCost" min="0" step="0.01" value="120.00">
                        </div>
                        <div class="form-group">
                            <label for="sheetMaterial">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª:</label>
                            <select id="sheetMaterial">
                                <option value="–ü–î–ß 18–º–º">–ü–î–ß 18–º–º</option>
                                <option value="–ú–î–§ 18–º–º">–ú–î–§ 18–º–º</option>
                                <option value="–•–î–õ 18–º–º">–•–î–õ 18–º–º</option>
                                <option value="–ú–∞—Å–∏–≤ 20–º–º">–ú–∞—Å–∏–≤ 20–º–º</option>
                                <option value="–ü–î–ß 3–º–º">–ü–î–ß 3–º–º</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sheetGrain">üåæ Grain direction:</label>
                            <select id="sheetGrain">
                                <option value="auto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</option>
                                <option value="horizontal" selected>–•–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–µ–Ω ‚Üí</option>
                                <option value="vertical">–í–µ—Ä—Ç–∏–∫–∞–ª–µ–Ω ‚Üë</option>
                                <option value="any">–ë–µ–∑ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-secondary">üì¶ –î–æ–±–∞–≤–∏ –ª–∏—Å—Ç</button>
                </form>

                <div class="sheets-list" id="sheetsList">
                    <p style="color: #6c757d; text-align: center; padding: 20px;">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –ª–∏—Å—Ç–æ–≤–µ</p>
                </div>

                <div class="test-buttons">
                    <button id="optimizationTestBtn" class="btn btn-warning">üß™ –¢–µ—Å—Ç –∑–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</button>
                    <button id="realTestBtn" class="btn btn-info">üè† –†–µ–∞–ª–µ–Ω –ø—Ä–∏–º–µ—Ä (–¥–æ–ª–µ–Ω —à–∫–∞—Ñ)</button>
                </div>

                <div style="margin-top: 25px; text-align: center;">
                    <button id="calculateBtn" class="btn" style="padding: 12px 30px; font-size: 1.1em;">
                        üßÆ –ò–∑—á–∏—Å–ª–∏ –æ–ø—Ç–∏–º–∞–ª–Ω–æ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ
                    </button>
                    <button id="clearBtn" class="btn btn-danger" style="margin-left: 15px;">
                        üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏ –≤—Å–∏—á–∫–æ
                    </button>
                </div>
            </div>

            <!-- –î—è—Å–Ω–∞ –∫–æ–ª–æ–Ω–∞: –†–µ–∑—É–ª—Ç–∞—Ç–∏ -->
            <div class="visualization-section">
                <h3>3. –†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è—Ç–∞</h3>

                <div id="resultsContainer">
                    <div id="noResultsMessage" style="text-align: center; padding: 40px; color: #6c757d;">
                        <p style="font-size: 1.2em;">–î–æ–±–∞–≤–µ—Ç–µ –¥–µ—Ç–∞–π–ª–∏ –∏ –ª–∏—Å—Ç–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª, —Å–ª–µ–¥ –∫–æ–µ—Ç–æ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ "–ò–∑—á–∏—Å–ª–∏"</p>
                    </div>
                    <div id="visualizationResults" style="display: none;"></div>
                </div>

                <div class="visualization-controls" style="display: none;" id="vizControls">
                    <button id="zoomInBtn" class="btn btn-small">üîç –£–≤–µ–ª–∏—á–∏</button>
                    <button id="zoomOutBtn" class="btn btn-small">üîç –ù–∞–º–∞–ª–∏</button>
                    <button id="toggleLabelsBtn" class="btn btn-small">üè∑Ô∏è –ü—Ä–µ–∫–ª—é—á–∏ –µ—Ç–∏–∫–µ—Ç–∏</button>
                    <button id="toggleGridBtn" class="btn btn-small">üìê –ü—Ä–µ–∫–ª—é—á–∏ –º—Ä–µ–∂–∞</button>
                </div>

                <div id="statisticsContainer" style="display: none;">
                    <h4 style="margin-top: 30px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                    <div class="stats-grid" id="statsGrid"></div>
                    <div style="margin-top: 25px;">
                        <canvas id="materialChart" height="200"></canvas>
                    </div>
                    <div id="detailedReport" class="detailed-report"></div>
                    <div style="margin-top: 25px; text-align: center;">
                        <button id="exportBtn" class="btn btn-success">üíæ –ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–π –ø—Ä–æ–µ–∫—Ç</button>
                        <button id="printBtn" class="btn btn-secondary" style="margin-left: 10px;">üñ®Ô∏è –ü—Ä–∏–Ω—Ç–∏—Ä–∞–π –æ—Ç—á–µ—Ç</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥—É–ª–µ–Ω JavaScript ‚Äì –∏–∑–ø–æ–ª–∑–≤–∞–º–µ –Ω–æ–≤–∏—Ç–µ engine/visualizer -->
    <script type="module">
        import { CutListEngine } from './js/cutlist/engine.js';
        import { CutListVisualizer } from './js/cutlist/visualizer.js';

        const engine = new CutListEngine();
        let chartInstance = null;
        let visualizationOptions = {
            scale: 0.25,
            showLabels: true,
            showGrid: true,
            showDimensions: true,
            showGrain: true,
            showGrainViolations: true
        };

        // -------------------- DOM –µ–ª–µ–º–µ–Ω—Ç–∏ --------------------
        const partForm = document.getElementById('partForm');
        const sheetForm = document.getElementById('sheetForm');
        const calculateBtn = document.getElementById('calculateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const partsList = document.getElementById('partsList');
        const sheetsList = document.getElementById('sheetsList');
        const resultsContainer = document.getElementById('visualizationResults');
        const statsContainer = document.getElementById('statisticsContainer');
        const statsGrid = document.getElementById('statsGrid');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const detailedReport = document.getElementById('detailedReport');
        const optimizationTestBtn = document.getElementById('optimizationTestBtn');
        const realTestBtn = document.getElementById('realTestBtn');
        const vizControls = document.getElementById('vizControls');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const toggleLabelsBtn = document.getElementById('toggleLabelsBtn');
        const toggleGridBtn = document.getElementById('toggleGridBtn');
        const exportBtn = document.getElementById('exportBtn');
        const printBtn = document.getElementById('printBtn');

        // -------------------- –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç UI --------------------
        function loadSettingsFromForm() {
            engine.settings.allowRotation = document.getElementById('allowRotation').checked;
            engine.settings.respectGrainDirection = document.getElementById('respectGrain').checked;
            engine.settings.cuttingBladeWidth = parseFloat(document.getElementById('bladeWidth').value);
            engine.settings.minWasteArea = parseFloat(document.getElementById('minWaste').value);
            engine.settings.sortingMethod = document.getElementById('sortingMethod').value;
            engine.settings.heuristic = document.getElementById('heuristic').value;
            visualizationOptions.showGrain = document.getElementById('showGrainViz').checked;
            visualizationOptions.showGrainViolations = document.getElementById('showGrainWarnings').checked;
        }

        // -------------------- –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª --------------------
        partForm.addEventListener('submit', function(e) {
            e.preventDefault();
            loadSettingsFromForm();
            const name = document.getElementById('partName').value.trim();
            const width = parseInt(document.getElementById('partWidth').value);
            const height = parseInt(document.getElementById('partHeight').value);
            const quantity = parseInt(document.getElementById('partQuantity').value);
            const material = document.getElementById('partMaterial').value;
            const grainSelect = document.getElementById('partGrain').value;
            const priority = parseInt(document.getElementById('partPriority').value);
            const allowRotation = document.getElementById('partAllowRotation').value === 'true';

            if (!name) { alert('–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∞!'); return; }
            if (width < 10 || height < 10) { alert('–†–∞–∑–º–µ—Ä–∏—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ –ø–æ–Ω–µ 10–º–º!'); return; }

            let grainDirection = grainSelect;
            if (grainSelect === 'auto') {
                grainDirection = engine.detectGrainDirection(material, width, height);
            }

            engine.addPart(name, width, height, quantity, material, {
                grainDirection,
                priority,
                allowRotation
            });

            updatePartsList();
            document.getElementById('partName').value = '';
            document.getElementById('partName').focus();
        });

        // -------------------- –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ª–∏—Å—Ç --------------------
        sheetForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('sheetName')?.value || '–õ–∏—Å—Ç';
            const width = parseInt(document.getElementById('sheetWidth').value);
            const height = parseInt(document.getElementById('sheetHeight').value);
            const cost = parseFloat(document.getElementById('sheetCost').value);
            const material = document.getElementById('sheetMaterial').value;
            const grainSelect = document.getElementById('sheetGrain').value;

            if (width < 100 || height < 100) { alert('–†–∞–∑–º–µ—Ä–∏—Ç–µ –Ω–∞ –ª–∏—Å—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ –ø–æ–Ω–µ 100–º–º!'); return; }

            let grainDirection = grainSelect;
            if (grainSelect === 'auto') {
                grainDirection = engine.detectGrainDirection(material, width, height);
            }

            engine.addSheet(name, width, height, cost, material, { grainDirection });
            updateSheetsList();
        });

        // -------------------- –ò–∑—á–∏—Å–ª–µ–Ω–∏–µ --------------------
        calculateBtn.addEventListener('click', function() {
            loadSettingsFromForm();
            if (engine.parts.length === 0) { alert('–î–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–∏–Ω –¥–µ—Ç–∞–π–ª!'); return; }
            if (engine.sheets.length === 0) { alert('–î–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–∏–Ω –ª–∏—Å—Ç –º–∞—Ç–µ—Ä–∏–∞–ª!'); return; }

            calculateBtn.innerHTML = '‚è≥ –û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–µ...';
            calculateBtn.disabled = true;

            setTimeout(() => {
                try {
                    const results = engine.calculateOptimization();
                    const stats = engine.getStatistics();
                    if (results && results.length > 0) {
                        displayResults(results, stats);
                        CutListVisualizer.generateReport(engine, 'detailedReport');
                        vizControls.style.display = 'flex';
                        detailedReport.style.display = 'block';
                    } else {
                        alert('–ù–µ –º–æ–∂–∞ –¥–∞ —Å–µ –Ω–∞–º–µ—Ä–∏ –ø–æ–¥—Ö–æ–¥—è—â–æ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ. –ü—Ä–æ–±–≤–∞–π—Ç–µ —Å –ø–æ-–≥–æ–ª–µ–º–∏ –ª–∏—Å—Ç–æ–≤–µ –∏–ª–∏ —Ä–∞–∑—Ä–µ—à–µ—Ç–µ –∑–∞–≤—ä—Ä—Ç–∞–Ω–µ.');
                    }
                } catch (error) {
                    console.error(error);
                    alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ: ' + error.message);
                } finally {
                    calculateBtn.innerHTML = 'üßÆ –ò–∑—á–∏—Å–ª–∏ –æ–ø—Ç–∏–º–∞–ª–Ω–æ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ';
                    calculateBtn.disabled = false;
                }
            }, 500);
        });

        // -------------------- –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ --------------------
        clearBtn.addEventListener('click', function() {
            if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—á–∏—Å—Ç–∏—Ç–µ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏?')) {
                engine.parts = [];
                engine.sheets = [];
                engine.results = [];
                updatePartsList();
                updateSheetsList();
                noResultsMessage.style.display = 'block';
                resultsContainer.style.display = 'none';
                statsContainer.style.display = 'none';
                detailedReport.style.display = 'none';
                vizControls.style.display = 'none';
                resultsContainer.innerHTML = '';
                detailedReport.innerHTML = '';
                if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
            }
        });

        // -------------------- –¢–µ—Å—Ç–æ–≤–∏ –ø—Ä–∏–º–µ—Ä–∏ (–æ–±—Ä–∞—Ç–Ω–æ —Å—ä–≤–º–µ—Å—Ç–∏–º–∏) --------------------
        optimizationTestBtn.addEventListener('click', function() {
            if (confirm('–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–∏ –¥–∞–Ω–Ω–∏? –¢–æ–≤–∞ —â–µ –∏–∑—á–∏—Å—Ç–∏ —Ç–µ–∫—É—â–∏—Ç–µ.')) {
                engine.parts = [];
                engine.sheets = [];
                engine.addPart('–°—Ç—Ä–∞–Ω–∏—Ü–∞', 760, 560, 2, '–ü–î–ß 18–º–º');
                engine.addPart('–î—ä–Ω–æ', 744, 560, 1, '–ü–î–ß 18–º–º');
                engine.addPart('–†–∞—Ñ—Ç', 743, 530, 1, '–ü–î–ß 18–º–º');
                engine.addPart('–í—Ä–∞—Ç–∏—á–∫–∞', 380, 560, 4, '–ü–î–ß 18–º–º');
                engine.addSheet('–ü–î–ß –ª–∏—Å—Ç', 2070, 2800, 120, '–ü–î–ß 18–º–º');
                updatePartsList();
                updateSheetsList();
                alert('–¢–µ—Å—Ç–æ–≤–∏ –¥–∞–Ω–Ω–∏ –∑–∞—Ä–µ–¥–µ–Ω–∏. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ "–ò–∑—á–∏—Å–ª–∏".');
            }
        });

        realTestBtn.addEventListener('click', function() {
            if (confirm('–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ä–µ–∞–ª–µ–Ω –ø—Ä–∏–º–µ—Ä (–¥–æ–ª–µ–Ω —à–∫–∞—Ñ)?')) {
                engine.parts = [];
                engine.sheets = [];
                engine.addPart('–°—Ç—Ä–∞–Ω–∏—Ü–∞', 760, 560, 2, '–ü–î–ß 18–º–º');
                engine.addPart('–î—ä–Ω–æ', 564, 560, 1, '–ü–î–ß 18–º–º');
                engine.addPart('–ì—Ä—ä–±', 740, 560, 1, '–ü–î–ß 3–º–º');
                engine.addPart('–í—Ä–∞—Ç–∏—á–∫–∞', 597, 388, 2, '–ü–î–ß 18–º–º');
                engine.addPart('–†–∞—Ñ—Ç', 564, 530, 1, '–ü–î–ß 18–º–º');
                engine.addPart('–°—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä', 564, 100, 2, '–ü–î–ß 18–º–º');
                engine.addSheet('–ü–î–ß –ª–∏—Å—Ç 18–º–º', 2070, 2800, 120, '–ü–î–ß 18–º–º');
                engine.addSheet('–ü–î–ß –ª–∏—Å—Ç 3–º–º', 2070, 2800, 80, '–ü–î–ß 3–º–º');
                updatePartsList();
                updateSheetsList();
                alert('–†–µ–∞–ª–µ–Ω –ø—Ä–∏–º–µ—Ä –∑–∞—Ä–µ–¥–µ–Ω.');
            }
        });

        // -------------------- –í–∏–∑—É–∞–ª–Ω–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏ --------------------
        zoomInBtn.addEventListener('click', function() {
            if (visualizationOptions.scale < 1.0) {
                visualizationOptions.scale += 0.1;
                redrawVisualizations();
            }
        });
        zoomOutBtn.addEventListener('click', function() {
            if (visualizationOptions.scale > 0.1) {
                visualizationOptions.scale -= 0.1;
                redrawVisualizations();
            }
        });
        toggleLabelsBtn.addEventListener('click', function() {
            visualizationOptions.showLabels = !visualizationOptions.showLabels;
            this.textContent = visualizationOptions.showLabels ? 'üè∑Ô∏è –°–∫—Ä–∏–π –µ—Ç–∏–∫–µ—Ç–∏' : 'üè∑Ô∏è –ü–æ–∫–∞–∂–∏ –µ—Ç–∏–∫–µ—Ç–∏';
            redrawVisualizations();
        });
        toggleGridBtn.addEventListener('click', function() {
            visualizationOptions.showGrid = !visualizationOptions.showGrid;
            this.textContent = visualizationOptions.showGrid ? 'üìê –°–∫—Ä–∏–π –º—Ä–µ–∂–∞' : 'üìê –ü–æ–∫–∞–∂–∏ –º—Ä–µ–∂–∞';
            redrawVisualizations();
        });

        // -------------------- –ï–∫—Å–ø–æ—Ä—Ç / –ü—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ --------------------
        exportBtn.addEventListener('click', function() {
            const project = engine.exportProject();
            const dataStr = JSON.stringify(project, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const fileName = `cutlist_project_${new Date().toISOString().slice(0,10)}.json`;
            const a = document.createElement('a');
            a.setAttribute('href', dataUri);
            a.setAttribute('download', fileName);
            a.click();
            alert('–ü—Ä–æ–µ–∫—Ç—ä—Ç –µ –µ–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–Ω.');
        });
        printBtn.addEventListener('click', () => window.print());

        // -------------------- –ü–æ–º–æ—â–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å–ø–∏—Å—ä—Ü–∏—Ç–µ --------------------
        function updatePartsList() {
            partsList.innerHTML = '';
            if (engine.parts.length === 0) {
                partsList.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –¥–µ—Ç–∞–π–ª–∏</p>';
                return;
            }
            const grouped = {};
            engine.parts.forEach(part => {
                const key = `${part.name}|${part.width}|${part.height}|${part.material}|${part.grainDirection}`;
                if (!grouped[key]) grouped[key] = { ...part, count: 0 };
                grouped[key].count++;
            });
            Object.values(grouped).forEach(part => {
                const grainIcon = part.grainDirection === 'horizontal' ? '‚Üí' : (part.grainDirection === 'vertical' ? '‚Üë' : '‚óã');
                const el = document.createElement('div');
                el.className = 'cabinet-list-item';
                el.innerHTML = `
                    <div style="flex:1;">
                        <strong>${part.name}</strong>
                        <br><small>${part.width}√ó${part.height}–º–º | ${part.material} ${grainIcon} | –ë—Ä–æ–π: ${part.count}</small>
                    </div>
                    <button class="btn btn-danger btn-small remove-part-btn" data-key="${part.name}|${part.width}|${part.height}|${part.material}|${part.grainDirection}">üóëÔ∏è</button>
                `;
                partsList.appendChild(el);
            });
            document.querySelectorAll('.remove-part-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const key = this.getAttribute('data-key');
                    removePartByKey(key);
                });
            });
        }

        function updateSheetsList() {
            sheetsList.innerHTML = '';
            if (engine.sheets.length === 0) {
                sheetsList.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –ª–∏—Å—Ç–æ–≤–µ</p>';
                return;
            }
            engine.sheets.forEach(sheet => {
                const grainIcon = sheet.grainDirection === 'horizontal' ? '‚Üí' : (sheet.grainDirection === 'vertical' ? '‚Üë' : '‚óã');
                const el = document.createElement('div');
                el.className = 'cabinet-list-item';
                el.innerHTML = `
                    <div style="flex:1;">
                        <strong>${sheet.name}</strong>
                        <br><small>${sheet.width}√ó${sheet.height}–º–º | ${sheet.materialType} ${grainIcon} | ${sheet.cost} –ª–≤.</small>
                    </div>
                    <button class="btn btn-danger btn-small remove-sheet-btn" data-id="${sheet.id}">üóëÔ∏è</button>
                `;
                sheetsList.appendChild(el);
            });
            document.querySelectorAll('.remove-sheet-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    removeSheet(id);
                });
            });
        }

        function removePartByKey(key) {
            if (!confirm('–ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –¥–µ—Ç–∞–π–ª–∏ –æ—Ç —Ç–æ–∑–∏ —Ç–∏–ø?')) return;
            const [name, width, height, material, grainDirection] = key.split('|');
            engine.parts = engine.parts.filter(p =>
                !(p.name === name &&
                  p.width === parseInt(width) &&
                  p.height === parseInt(height) &&
                  p.material === material &&
                  p.grainDirection === grainDirection)
            );
            updatePartsList();
        }

        function removeSheet(id) {
            if (!confirm('–ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –ª–∏—Å—Ç?')) return;
            engine.sheets = engine.sheets.filter(s => s.id !== id);
            updateSheetsList();
        }

        // -------------------- –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ --------------------
        function displayResults(results, statistics) {
            noResultsMessage.style.display = 'none';
            resultsContainer.style.display = 'block';
            statsContainer.style.display = 'block';
            resultsContainer.innerHTML = '';
            statsGrid.innerHTML = '';

            results.forEach((sheet, index) => {
                if (!sheet || !sheet.placedParts || sheet.placedParts.length === 0) return;
                const sheetContainer = document.createElement('div');
                sheetContainer.className = 'sheet-container';
                sheetContainer.id = `sheet-${index}`;
                sheetContainer.innerHTML = `
                    <h5>–õ–∏—Å—Ç ${index + 1}: ${sheet.width} √ó ${sheet.height} –º–º (${sheet.materialType})</h5>
                    <div class="sheet-visualization" id="sheetVisualization${index}"></div>
                    <p><small>–î–µ—Ç–∞–π–ª–∏: ${sheet.placedParts.length} –±—Ä. | –ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç: ${sheet.efficiency ? sheet.efficiency.toFixed(1) : 0}%</small></p>
                `;
                resultsContainer.appendChild(sheetContainer);
                try {
                    const svg = CutListVisualizer.generateSVG(sheet, visualizationOptions);
                    document.getElementById(`sheetVisualization${index}`).innerHTML = svg;
                } catch (e) {
                    console.error('SVG –≥—Ä–µ—à–∫–∞:', e);
                    document.getElementById(`sheetVisualization${index}`).innerHTML = '<p style="color:#dc3545;">–ì—Ä–µ—à–∫–∞ –≤—ä–≤ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è—Ç–∞</p>';
                }
            });

            if (statistics) {
                statsGrid.innerHTML = `
                    <div class="stat-card"><div class="stat-label">–û–±—â–æ –ª–∏—Å—Ç–æ–≤–µ</div><div class="stat-value">${statistics.totalSheets}</div></div>
                    <div class="stat-card"><div class="stat-label">–û–±—â–æ –¥–µ—Ç–∞–π–ª–∏</div><div class="stat-value">${statistics.totalParts}</div></div>
                    <div class="stat-card"><div class="stat-label">–ü–æ—Å—Ç–∞–≤–µ–Ω–∏ –¥–µ—Ç–∞–π–ª–∏</div><div class="stat-value">${statistics.placedParts} (${statistics.placementRate})</div></div>
                    <div class="stat-card"><div class="stat-label">–ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç</div><div class="stat-value">${statistics.materialEfficiency}</div></div>
                    <div class="stat-card ${statistics.grainViolations > 0 ? 'grain-warning' : 'grain-ok'}">
                        <div class="stat-label">üåæ Grain —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
                        <div class="stat-value">${statistics.grainCompliance}</div>
                    </div>
                    <div class="stat-card"><div class="stat-label">–ü—Ä–∏–±–ª. —Ü–µ–Ω–∞</div><div class="stat-value">${statistics.estimatedCost}</div></div>
                `;

                if (statistics.totalSheetArea > 0) {
                    const ctx = document.getElementById('materialChart');
                    if (ctx) {
                        if (chartInstance) chartInstance.destroy();
                        chartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['–ò–∑–ø–æ–ª–∑–≤–∞–Ω', '–û—Ç–ø–∞–¥—ä–∫'],
                                datasets: [{
                                    data: [statistics.totalUsedArea, statistics.totalWasteArea],
                                    backgroundColor: ['#4CAF50', '#FF9800'],
                                    borderWidth: 1
                                }]
                            }
                        });
                    }
                }
            }
        }

        function redrawVisualizations() {
            if (engine.results && engine.results.length) {
                engine.results.forEach((sheet, idx) => {
                    const viz = document.getElementById(`sheetVisualization${idx}`);
                    if (viz) viz.innerHTML = CutListVisualizer.generateSVG(sheet, visualizationOptions);
                });
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            updatePartsList();
            updateSheetsList();
            document.getElementById('partName').focus();
        });
    </script>
</body>
</html>