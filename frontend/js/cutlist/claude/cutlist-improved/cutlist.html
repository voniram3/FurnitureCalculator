<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cut-list –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä - –ú–µ–±–µ–ª–µ–Ω –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .cutlist-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .cutlist-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .cutlist-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 1024px) {
            .cutlist-grid {
                grid-template-columns: 1fr;
            }
        }

        .input-section, .visualization-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .parts-list, .sheets-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
        }

        .cutlist-svg {
            width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .sheet-container {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #fff;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .settings-panel {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .detailed-report {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: none;
        }

        .report-section {
            margin-bottom: 25px;
        }

        .report-table, .sheet-details {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .report-table td, .sheet-details td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .report-table tr:last-child td, .sheet-details tr:last-child td {
            border-bottom: none;
        }

        .sheet-report {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }

        .test-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .cutlist-part:hover {
            stroke-width: 2px;
            stroke: #dc3545 !important;
        }

        .visualization-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        #visualizationResults {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="cutlist-container">
        <header class="cutlist-header">
            <h1>‚úÇÔ∏è Cut-list –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä</h1>
            <p>–û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–π—Ç–µ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ—Ç–æ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏ –∑–∞ –º–∏–Ω–∏–º–∞–ª–Ω–∏ –æ—Ç–ø–∞–¥—ä—Ü–∏</p>
        </header>

        <div class="cutlist-grid">
            <!-- –õ—è–≤–∞ –∫–æ–ª–æ–Ω–∞: –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ -->
            <div class="input-section">
                <h3>1. –î–µ—Ç–∞–π–ª–∏ –∑–∞ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ</h3>
                <form id="partForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="partName">–ò–º–µ –Ω–∞ –¥–µ—Ç–∞–π–ª:</label>
                            <input type="text" id="partName" placeholder="–°—Ç—Ä–∞–Ω–∏—Ü–∞, –î—ä–Ω–æ, –†–∞—Ñ—Ç..." required>
                        </div>
                        <div class="form-group">
                            <label for="partWidth">–®–∏—Ä–æ—á–∏–Ω–∞ (mm):</label>
                            <input type="number" id="partWidth" min="10" value="500" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="partHeight">–í–∏—Å–æ—á–∏–Ω–∞ (mm):</label>
                            <input type="number" id="partHeight" min="10" value="700" required>
                        </div>
                        <div class="form-group">
                            <label for="partQuantity">–ë—Ä–æ–π:</label>
                            <input type="number" id="partQuantity" min="1" value="1" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="partMaterial">–ú–∞—Ç–µ—Ä–∏–∞–ª:</label>
                        <select id="partMaterial">
                            <option value="–ü–î–ß 18–º–º">–ü–î–ß 18–º–º</option>
                            <option value="–ú–î–§ 18–º–º">–ú–î–§ 18–º–º</option>
                            <option value="–•–î–õ 38–º–º">–•–î–õ 38–º–º</option>
                            <option value="–ú–∞—Å–∏–≤">–ú–∞—Å–∏–≤</option>
                            <option value="–ì—Ä—ä–± –ü–î–ß">–ì—Ä—ä–± –ü–î–ß</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏ –¥–µ—Ç–∞–π–ª</button>
                </form>

                <div class="parts-list" id="partsList">
                    <!-- –î–∏–Ω–∞–º–∏—á–Ω–æ —â–µ —Å–µ –ø–æ–ø—ä–ª–≤–∞ —Å—ä—Å –¥–æ–±–∞–≤–µ–Ω–∏—Ç–µ –¥–µ—Ç–∞–π–ª–∏ -->
                    <p style="color: #6c757d; text-align: center; padding: 20px;">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –¥–µ—Ç–∞–π–ª–∏</p>
                </div>

                <div class="settings-panel">
                    <h4>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è—Ç–∞</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allowRotation" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="allowRotation" checked>
                                <span>–ü–æ–∑–≤–æ–ª–∏ –∑–∞–≤—ä—Ä—Ç–∞–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∏</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="sortingMethod">–°–æ—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∏:</label>
                            <select id="sortingMethod">
                                <option value="area">–ü–æ –ø–ª–æ—â (–Ω–∞–π-–≥–æ–ª–µ–º–∏ –ø—ä—Ä–≤–∏)</option>
                                <option value="maxside">–ü–æ –Ω–∞–π-–¥—ä–ª–≥–∞ —Å—Ç—Ä–∞–Ω–∞</option>
                                <option value="width">–ü–æ —à–∏—Ä–æ—á–∏–Ω–∞</option>
                                <option value="height">–ü–æ –≤–∏—Å–æ—á–∏–Ω–∞</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bladeWidth">–î–µ–±–µ–ª–∏–Ω–∞ –Ω–∞ —Ä–µ–∂–µ—â–æ –æ—Å—Ç—Ä–∏–µ (mm):</label>
                            <input type="number" id="bladeWidth" min="0" max="10" step="0.5" value="4">
                        </div>
                        <div class="form-group">
                            <label for="minWaste">–ú–∏–Ω–∏–º–∞–ª–µ–Ω –æ—Ç–ø–∞–¥—ä–∫ (mm¬≤):</label>
                            <input type="number" id="minWaste" min="0" step="1000" value="10000">
                        </div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">2. –õ–∏—Å—Ç–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª</h3>
                <form id="sheetForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sheetWidth">–®–∏—Ä–æ—á–∏–Ω–∞ –Ω–∞ –ª–∏—Å—Ç (mm):</label>
                            <input type="number" id="sheetWidth" min="100" value="2070" required>
                        </div>
                        <div class="form-group">
                            <label for="sheetHeight">–í–∏—Å–æ—á–∏–Ω–∞ –Ω–∞ –ª–∏—Å—Ç (mm):</label>
                            <input type="number" id="sheetHeight" min="100" value="2800" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sheetCost">–¶–µ–Ω–∞ –Ω–∞ –ª–∏—Å—Ç (–ª–≤.):</label>
                            <input type="number" id="sheetCost" min="0" step="0.01" value="120.00">
                        </div>
                        <div class="form-group">
                            <label for="sheetMaterial">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª:</label>
                            <select id="sheetMaterial">
                                <option value="–ü–î–ß 18–º–º">–ü–î–ß 18–º–º</option>
                                <option value="–ú–î–§ 18–º–º">–ú–î–§ 18–º–º</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-secondary">üì¶ –î–æ–±–∞–≤–∏ –ª–∏—Å—Ç</button>
                </form>

                <div class="sheets-list" id="sheetsList">
                    <!-- –î–∏–Ω–∞–º–∏—á–Ω–æ —â–µ —Å–µ –ø–æ–ø—ä–ª–≤–∞ —Å –¥–æ–±–∞–≤–µ–Ω–∏—Ç–µ –ª–∏—Å—Ç–æ–≤–µ -->
                    <p style="color: #6c757d; text-align: center; padding: 20px;">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –ª–∏—Å—Ç–æ–≤–µ</p>
                </div>

                <div class="test-buttons">
                    <button id="optimizationTestBtn" class="btn btn-warning">üß™ –¢–µ—Å—Ç –∑–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</button>
                    <button id="realTestBtn" class="btn btn-info">üè† –†–µ–∞–ª–µ–Ω –ø—Ä–∏–º–µ—Ä (–¥–æ–ª–µ–Ω —à–∫–∞—Ñ)</button>
                </div>

                <div style="margin-top: 25px; text-align: center;">
                    <button id="calculateBtn" class="btn" style="padding: 12px 30px; font-size: 1.1em;">
                        üßÆ –ò–∑—á–∏—Å–ª–∏ –æ–ø—Ç–∏–º–∞–ª–Ω–æ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ
                    </button>
                    <button id="clearBtn" class="btn btn-danger" style="margin-left: 15px;">
                        üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏ –≤—Å–∏—á–∫–æ
                    </button>
                </div>
            </div>

            <!-- –î—è—Å–Ω–∞ –∫–æ–ª–æ–Ω–∞: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ -->
            <div class="visualization-section">
                <h3>3. –†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è—Ç–∞</h3>

                <div id="resultsContainer">
                    <div id="noResultsMessage" style="text-align: center; padding: 40px; color: #6c757d;">
                        <p style="font-size: 1.2em;">–î–æ–±–∞–≤–µ—Ç–µ –¥–µ—Ç–∞–π–ª–∏ –∏ –ª–∏—Å—Ç–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª, —Å–ª–µ–¥ –∫–æ–µ—Ç–æ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ "–ò–∑—á–∏—Å–ª–∏"</p>
                    </div>
                    <div id="visualizationResults" style="display: none;">
                        <!-- –¢—É–∫ —â–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏—Ç–µ -->
                    </div>
                </div>

                <div class="visualization-controls" style="display: none;" id="vizControls">
                    <button id="zoomInBtn" class="btn btn-small">üîç –£–≤–µ–ª–∏—á–∏</button>
                    <button id="zoomOutBtn" class="btn btn-small">üîç –ù–∞–º–∞–ª–∏</button>
                    <button id="toggleLabelsBtn" class="btn btn-small">üè∑Ô∏è –ü—Ä–µ–∫–ª—é—á–∏ –µ—Ç–∏–∫–µ—Ç–∏</button>
                    <button id="toggleGridBtn" class="btn btn-small">üìê –ü—Ä–µ–∫–ª—é—á–∏ –º—Ä–µ–∂–∞</button>
                </div>

                <div id="statisticsContainer" style="display: none;">
                    <h4 style="margin-top: 30px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                    <div class="stats-grid" id="statsGrid">
                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏—Ç–µ —â–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç —Ç—É–∫ -->
                    </div>

                    <div style="margin-top: 25px;">
                        <canvas id="materialChart" height="200"></canvas>
                    </div>

                    <div id="detailedReport" class="detailed-report">
                        <!-- –î–µ—Ç–∞–π–ª–Ω–∏—è—Ç –æ—Ç—á–µ—Ç —â–µ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞ —Ç—É–∫ -->
                    </div>

                    <div style="margin-top: 25px; text-align: center;">
                        <button id="exportBtn" class="btn btn-success">üíæ –ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–π –ø—Ä–æ–µ–∫—Ç</button>
                        <button id="printBtn" class="btn btn-secondary" style="margin-left: 10px;">üñ®Ô∏è –ü—Ä–∏–Ω—Ç–∏—Ä–∞–π –æ—Ç—á–µ—Ç</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥—É–ª–µ–Ω JavaScript -->
    <script type="module">
        import { CutListEngine } from './js/cutlist/engine.js';
        import { CutListVisualizer } from './js/cutlist/visualizer.js';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const engine = new CutListEngine();
        let chartInstance = null;
        let visualizationOptions = {
            scale: 0.25,
            showLabels: true,
            showGrid: true,
            showDimensions: true
        };

        // DOM –µ–ª–µ–º–µ–Ω—Ç–∏
        const partForm = document.getElementById('partForm');
        const sheetForm = document.getElementById('sheetForm');
        const calculateBtn = document.getElementById('calculateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const partsList = document.getElementById('partsList');
        const sheetsList = document.getElementById('sheetsList');
        const resultsContainer = document.getElementById('visualizationResults');
        const statsContainer = document.getElementById('statisticsContainer');
        const statsGrid = document.getElementById('statsGrid');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const detailedReport = document.getElementById('detailedReport');
        const optimizationTestBtn = document.getElementById('optimizationTestBtn');
        const realTestBtn = document.getElementById('realTestBtn');
        const vizControls = document.getElementById('vizControls');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const toggleLabelsBtn = document.getElementById('toggleLabelsBtn');
        const toggleGridBtn = document.getElementById('toggleGridBtn');
        const exportBtn = document.getElementById('exportBtn');
        const printBtn = document.getElementById('printBtn');

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª
        partForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª...');

            const name = document.getElementById('partName').value.trim();
            const width = parseInt(document.getElementById('partWidth').value);
            const height = parseInt(document.getElementById('partHeight').value);
            const quantity = parseInt(document.getElementById('partQuantity').value);
            const material = document.getElementById('partMaterial').value;

            if (!name) {
                alert('–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∞!');
                return;
            }

            if (width < 10 || height < 10) {
                alert('–†–∞–∑–º–µ—Ä–∏—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ –ø–æ–Ω–µ 10–º–º!');
                return;
            }

            engine.addPart(name, width, height, quantity, material);
            console.log('–î–µ—Ç–∞–π–ª–∏ —Å–ª–µ–¥ –¥–æ–±–∞–≤—è–Ω–µ:', engine.parts);

            updatePartsList();

            // –ù—É–ª–∏—Ä–∞–Ω–µ —Å–∞–º–æ –Ω–∞ –∏–º–µ—Ç–æ
            document.getElementById('partName').value = '';
            document.getElementById('partName').focus();
        });

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ª–∏—Å—Ç –º–∞—Ç–µ—Ä–∏–∞–ª
        sheetForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ª–∏—Å—Ç...');

            const width = parseInt(document.getElementById('sheetWidth').value);
            const height = parseInt(document.getElementById('sheetHeight').value);
            const cost = parseFloat(document.getElementById('sheetCost').value);
            const material = document.getElementById('sheetMaterial').value;
            const name = `–õ–∏—Å—Ç ${material} ${width}x${height}mm`;

            if (width < 100 || height < 100) {
                alert('–†–∞–∑–º–µ—Ä–∏—Ç–µ –Ω–∞ –ª–∏—Å—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ –ø–æ–Ω–µ 100–º–º!');
                return;
            }

            engine.addSheet(name, width, height, cost, material);
            console.log('–õ–∏—Å—Ç–æ–≤–µ —Å–ª–µ–¥ –¥–æ–±–∞–≤—è–Ω–µ:', engine.sheets);
            updateSheetsList();
        });

        // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞
        function loadSettingsFromForm() {
            engine.settings = {
                allowRotation: document.getElementById('allowRotation').checked,
                cuttingBladeWidth: parseFloat(document.getElementById('bladeWidth').value),
                minWasteArea: parseFloat(document.getElementById('minWaste').value),
                sortingMethod: document.getElementById('sortingMethod').value
            };
            console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–∏:', engine.settings);
        }

        // –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è—Ç–∞
        calculateBtn.addEventListener('click', function() {
            console.log('–ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è...');

            if (engine.parts.length === 0) {
                alert('–ú–æ–ª—è, –¥–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–∏–Ω –¥–µ—Ç–∞–π–ª –∑–∞ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ!');
                return;
            }

            if (engine.sheets.length === 0) {
                alert('–ú–æ–ª—è, –¥–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–∏–Ω –ª–∏—Å—Ç –º–∞—Ç–µ—Ä–∏–∞–ª!');
                return;
            }

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ
            loadSettingsFromForm();

            // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
            calculateBtn.innerHTML = '‚è≥ –û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–µ...';
            calculateBtn.disabled = true;

            // –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ
            setTimeout(() => {
                try {
                    const results = engine.calculateOptimization();
                    console.log('–†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:', results);

                    const stats = engine.getStatistics();
                    console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', stats);

                    // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
                    if (results && results.length > 0) {
                        displayResults(results, stats);

                        // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–µ–Ω –æ—Ç—á–µ—Ç
                        generateDetailedReport(engine);

                        // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ç–µ –∑–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                        vizControls.style.display = 'flex';
                        detailedReport.style.display = 'block';
                    } else {
                        alert('–ù–µ –º–æ–∂–∞ –¥–∞ —Å–µ –Ω–∞–º–µ—Ä–∏ –ø–æ–¥—Ö–æ–¥—è—â–æ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ. –û–ø–∏—Ç–∞–π—Ç–µ —Å –ø–æ-–≥–æ–ª–µ–º–∏ –ª–∏—Å—Ç–æ–≤–µ –∏–ª–∏ –∞–∫—Ç–∏–≤–∏—Ä–∞–π—Ç–µ –∑–∞–≤—ä—Ä—Ç–∞–Ω–µ.');
                    }
                } catch (error) {
                    console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ:', error);
                    alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ: ' + error.message);
                } finally {
                    // –í—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –±—É—Ç–æ–Ω–∞
                    calculateBtn.innerHTML = 'üßÆ –ò–∑—á–∏—Å–ª–∏ –æ–ø—Ç–∏–º–∞–ª–Ω–æ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ';
                    calculateBtn.disabled = false;
                }
            }, 500);
        });

        // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–æ
        clearBtn.addEventListener('click', function() {
            if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—á–∏—Å—Ç–∏—Ç–µ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏?')) {
                // –ù—É–ª–∏—Ä–∞–Ω–µ –Ω–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è
                engine.parts = [];
                engine.sheets = [];
                engine.results = [];

                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å–ø–∏—Å—ä—Ü–∏—Ç–µ
                updatePartsList();
                updateSheetsList();

                // –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
                noResultsMessage.style.display = 'block';
                resultsContainer.style.display = 'none';
                statsContainer.style.display = 'none';
                detailedReport.style.display = 'none';
                vizControls.style.display = 'none';
                resultsContainer.innerHTML = '';
                detailedReport.innerHTML = '';

                // –£–Ω–∏—â–æ–∂–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–∞—Ç–∞
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }

                console.log('–í—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏ —Å–∞ –∏–∑—á–∏—Å—Ç–µ–Ω–∏.');
            }
        });

        // –¢–µ—Å—Ç –∑–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
        optimizationTestBtn.addEventListener('click', function() {
            if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∑–∞—Ä–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è? –¢–æ–≤–∞ —â–µ –∏–∑—á–∏—Å—Ç–∏ —Ç–µ–∫—É—â–∏—Ç–µ –¥–∞–Ω–Ω–∏.')) {
                // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä–∏ –¥–∞–Ω–Ω–∏
                engine.parts = [];
                engine.sheets = [];

                // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∏, –∫–æ–∏—Ç–æ –º–æ–≥–∞—Ç –¥–∞ —Å–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–∞—Ç –≤ –µ–¥–∏–Ω –ª–∏—Å—Ç
                engine.addPart('–°—Ç—Ä–∞–Ω–∏—Ü–∞', 760, 560, 2, '–ü–î–ß 18–º–º');
                engine.addPart('–î—ä–Ω–æ', 744, 560, 1, '–ü–î–ß 18–º–º');
                engine.addPart('–†–∞—Ñ—Ç', 743, 530, 1, '–ü–î–ß 18–º–º');
                engine.addPart('–í—Ä–∞—Ç–∏—á–∫–∞', 380, 560, 4, '–ü–î–ß 18–º–º'); // –ü–æ-–º–∞–ª–∫–∏ –≤—Ä–∞—Ç–∏, –∫–æ–∏—Ç–æ –º–æ–≥–∞—Ç –¥–∞ —Å–µ –∑–∞–≤—ä—Ä—Ç—è—Ç

                // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ª–∏—Å—Ç
                engine.addSheet('–ü–î–ß –ª–∏—Å—Ç', 2070, 2800, 120.00, '–ü–î–ß 18–º–º');

                updatePartsList();
                updateSheetsList();

                console.log('–¢–µ—Å—Ç–æ–≤–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–æ–±–∞–≤–µ–Ω–∏');
                alert('–¢–µ—Å—Ç–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω–∏ —Å–∞ –¥–æ–±–∞–≤–µ–Ω–∏. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ "–ò–∑—á–∏—Å–ª–∏ –æ–ø—Ç–∏–º–∞–ª–Ω–æ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ" –∑–∞ –¥–∞ –≤–∏–¥–∏—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞.');
            }
        });

        // –†–µ–∞–ª–µ–Ω –ø—Ä–∏–º–µ—Ä (–¥–æ–ª–µ–Ω —à–∫–∞—Ñ)
        realTestBtn.addEventListener('click', function() {
            if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∑–∞—Ä–µ–¥–∏—Ç–µ —Ä–µ–∞–ª–µ–Ω –ø—Ä–∏–º–µ—Ä (–¥–æ–ª–µ–Ω —à–∫–∞—Ñ)? –¢–æ–≤–∞ —â–µ –∏–∑—á–∏—Å—Ç–∏ —Ç–µ–∫—É—â–∏—Ç–µ –¥–∞–Ω–Ω–∏.')) {
                // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä–∏ –¥–∞–Ω–Ω–∏
                engine.parts = [];
                engine.sheets = [];

                // –†–µ–∞–ª–Ω–∏ –¥–µ—Ç–∞–π–ª–∏ –∑–∞ –¥–æ–ª–µ–Ω —à–∫–∞—Ñ 600–º–º
                engine.addPart('–°—Ç—Ä–∞–Ω–∏—Ü–∞', 760, 560, 2, '–ü–î–ß 18–º–º');
                engine.addPart('–î—ä–Ω–æ', 564, 560, 1, '–ü–î–ß 18–º–º');
                engine.addPart('–ì—Ä—ä–±', 740, 560, 1, '–ü–î–ß 3–º–º');
                engine.addPart('–í—Ä–∞—Ç–∏—á–∫–∞', 597, 388, 2, '–ü–î–ß 18–º–º');
                engine.addPart('–†–∞—Ñ—Ç', 564, 530, 1, '–ü–î–ß 18–º–º');
                engine.addPart('–°—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä', 564, 100, 2, '–ü–î–ß 18–º–º');

                // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ª–∏—Å—Ç–æ–≤–µ
                engine.addSheet('–ü–î–ß –ª–∏—Å—Ç 18–º–º', 2070, 2800, 120.00, '–ü–î–ß 18–º–º');
                engine.addSheet('–ü–î–ß –ª–∏—Å—Ç 3–º–º', 2070, 2800, 80.00, '–ü–î–ß 3–º–º');

                updatePartsList();
                updateSheetsList();

                console.log('–†–µ–∞–ª–µ–Ω –ø—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–µ–Ω');
                alert('–†–µ–∞–ª–Ω–∏—è—Ç –ø—Ä–∏–º–µ—Ä –µ –¥–æ–±–∞–≤–µ–Ω. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ "–ò–∑—á–∏—Å–ª–∏ –æ–ø—Ç–∏–º–∞–ª–Ω–æ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ" –∑–∞ –¥–∞ –≤–∏–¥–∏—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞.');
            }
        });

        // –ö–æ–Ω—Ç—Ä–æ–ª–∏ –∑–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
        zoomInBtn.addEventListener('click', function() {
            if (visualizationOptions.scale < 1.0) {
                visualizationOptions.scale += 0.1;
                redrawVisualizations();
            }
        });

        zoomOutBtn.addEventListener('click', function() {
            if (visualizationOptions.scale > 0.1) {
                visualizationOptions.scale -= 0.1;
                redrawVisualizations();
            }
        });

        toggleLabelsBtn.addEventListener('click', function() {
            visualizationOptions.showLabels = !visualizationOptions.showLabels;
            this.textContent = visualizationOptions.showLabels ? 'üè∑Ô∏è –°–∫—Ä–∏–π –µ—Ç–∏–∫–µ—Ç–∏' : 'üè∑Ô∏è –ü–æ–∫–∞–∂–∏ –µ—Ç–∏–∫–µ—Ç–∏';
            redrawVisualizations();
        });

        toggleGridBtn.addEventListener('click', function() {
            visualizationOptions.showGrid = !visualizationOptions.showGrid;
            this.textContent = visualizationOptions.showGrid ? 'üìê –°–∫—Ä–∏–π –º—Ä–µ–∂–∞' : 'üìê –ü–æ–∫–∞–∂–∏ –º—Ä–µ–∂–∞';
            redrawVisualizations();
        });

        // –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞ –ø—Ä–æ–µ–∫—Ç
        exportBtn.addEventListener('click', function() {
            const projectData = engine.exportProject();
            const dataStr = JSON.stringify(projectData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = `cutlist_project_${new Date().toISOString().slice(0,10)}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            alert('–ü—Ä–æ–µ–∫—Ç—ä—Ç –µ –µ–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
        });

        // –ü—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –æ—Ç—á–µ—Ç
        printBtn.addEventListener('click', function() {
            window.print();
        });

        // –ü–æ–º–æ—â–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updatePartsList() {
            console.log('–û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å–ø–∏—Å—ä–∫–∞ —Å –¥–µ—Ç–∞–π–ª–∏...');
            partsList.innerHTML = '';

            if (engine.parts.length === 0) {
                partsList.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –¥–µ—Ç–∞–π–ª–∏</p>';
                return;
            }

            // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∏ –ø–æ –∏–º–µ –∏ —Ä–∞–∑–º–µ—Ä
            const groupedParts = {};
            engine.parts.forEach(part => {
                const key = `${part.name}|${part.width}|${part.height}|${part.material}`;
                if (!groupedParts[key]) {
                    groupedParts[key] = {
                        name: part.name,
                        width: part.width,
                        height: part.height,
                        material: part.material,
                        count: 0,
                        ids: []
                    };
                }
                groupedParts[key].count++;
                groupedParts[key].ids.push(part.id);
            });

            // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –≥—Ä—É–ø–∏—Ä–∞–Ω–∏—Ç–µ –¥–µ—Ç–∞–π–ª–∏
            Object.values(groupedParts).forEach(part => {
                const partElement = document.createElement('div');
                partElement.className = 'cabinet-list-item';
                partElement.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${part.name}</strong>
                        <br><small>${part.width} √ó ${part.height} –º–º | ${part.material} | –ë—Ä–æ–π: ${part.count}</small>
                    </div>
                    <button class="btn btn-danger btn-small remove-part-btn"
                            data-key="${part.name}|${part.width}|${part.height}|${part.material}">üóëÔ∏è</button>
                `;
                partsList.appendChild(partElement);
            });

            // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ event listeners –∑–∞ –±—É—Ç–æ–Ω–∏—Ç–µ –∑–∞ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ
            document.querySelectorAll('.remove-part-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const key = this.getAttribute('data-key');
                    removePartByKey(key);
                });
            });
        }

        function updateSheetsList() {
            console.log('–û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å–ø–∏—Å—ä–∫–∞ —Å –ª–∏—Å—Ç–æ–≤–µ...');
            sheetsList.innerHTML = '';

            if (engine.sheets.length === 0) {
                sheetsList.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –ª–∏—Å—Ç–æ–≤–µ</p>';
                return;
            }

            engine.sheets.forEach(sheet => {
                const sheetElement = document.createElement('div');
                sheetElement.className = 'cabinet-list-item';
                sheetElement.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${sheet.name}</strong>
                        <br><small>${sheet.width} √ó ${sheet.height} –º–º | ${sheet.cost} –ª–≤.</small>
                    </div>
                    <button class="btn btn-danger btn-small remove-sheet-btn"
                            data-id="${sheet.id}">üóëÔ∏è</button>
                `;
                sheetsList.appendChild(sheetElement);
            });

            // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ event listeners –∑–∞ –±—É—Ç–æ–Ω–∏—Ç–µ –∑–∞ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ
            document.querySelectorAll('.remove-sheet-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sheetId = this.getAttribute('data-id');
                    removeSheet(sheetId);
                });
            });
        }

        // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
        function displayResults(results, statistics) {
            console.log('–ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ...', results);

            // –°–∫—Ä–∏–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ "–Ω—è–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏"
            noResultsMessage.style.display = 'none';

            // –ü–æ–∫–∞–∑–≤–∞–º–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏—Ç–µ –∑–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
            resultsContainer.style.display = 'block';
            statsContainer.style.display = 'block';

            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –ø—Ä–µ–¥–∏—à–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
            resultsContainer.innerHTML = '';
            statsGrid.innerHTML = '';

            // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞ –≤—Å–µ–∫–∏ –ª–∏—Å—Ç
            if (results && results.length > 0) {
                results.forEach((sheet, index) => {
                    if (!sheet || !sheet.placedParts || sheet.placedParts.length === 0) {
                        return; // –ü—Ä–æ–ø—É—Å–∫–∞–º–µ –ø—Ä–∞–∑–Ω–∏—Ç–µ –ª–∏—Å—Ç–æ–≤–µ
                    }

                    const sheetContainer = document.createElement('div');
                    sheetContainer.className = 'sheet-container';
                    sheetContainer.id = `sheet-${index}`;
                    sheetContainer.innerHTML = `
                        <h5>–õ–∏—Å—Ç ${index + 1}: ${sheet.width} √ó ${sheet.height} –º–º (${sheet.materialType || '–ú–∞—Ç–µ—Ä–∏–∞–ª'})</h5>
                        <div class="sheet-visualization" id="sheetVisualization${index}"></div>
                        <p><small>–î–µ—Ç–∞–π–ª–∏: ${sheet.placedParts.length} –±—Ä. | –ò–∑–ø–æ–ª–∑–≤–∞–Ω–∞ –ø–ª–æ—â: ${sheet.usedArea ? Math.round(sheet.usedArea) : 0} mm¬≤ (${sheet.efficiency ? sheet.efficiency.toFixed(1) : 0}%)</small></p>
                    `;

                    resultsContainer.appendChild(sheetContainer);

                    // –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ SVG –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                    try {
                        const svg = CutListVisualizer.generateSVG(sheet, visualizationOptions);
                        const vizElement = document.getElementById(`sheetVisualization${index}`);
                        if (vizElement) {
                            vizElement.innerHTML = svg;
                        }
                    } catch (svgError) {
                        console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ SVG:', svgError);
                        document.getElementById(`sheetVisualization${index}`).innerHTML =
                            '<p style="color: #dc3545;">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</p>';
                    }
                });

                // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –æ–±—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–∫–æ –∏–º–∞ –ø–æ–≤–µ—á–µ –æ—Ç 1 –ª–∏—Å—Ç
                if (results.length > 1) {
                    const totalSheets = results.length;
                    const totalParts = results.reduce((sum, sheet) => sum + sheet.placedParts.length, 0);
                    const totalEfficiency = results.reduce((sum, sheet) => sum + (sheet.efficiency || 0), 0) / results.length;

                    const summary = document.createElement('div');
                    summary.className = 'sheet-container';
                    summary.style.background = '#e8f5e9';
                    summary.innerHTML = `
                        <h5>üìä –û–±—â–æ –∑–∞ –ø—Ä–æ–µ–∫—Ç–∞:</h5>
                        <p>–ò–∑–ø–æ–ª–∑–≤–∞–Ω–∏ –ª–∏—Å—Ç–æ–≤–µ: <strong>${totalSheets}</strong></p>
                        <p>–û–±—â–æ –¥–µ—Ç–∞–π–ª–∏: <strong>${totalParts}</strong></p>
                        <p>–°—Ä–µ–¥–Ω–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç: <strong>${totalEfficiency.toFixed(1)}%</strong></p>
                    `;
                    resultsContainer.insertBefore(summary, resultsContainer.firstChild);
                }
            } else {
                resultsContainer.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px;">–ù—è–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ. –û–ø–∏—Ç–∞–π—Ç–µ —Å —Ä–∞–∑–ª–∏—á–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</p>';
            }

            // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏—Ç–µ
            if (statistics) {
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">–û–±—â–æ –ª–∏—Å—Ç–æ–≤–µ</div>
                        <div class="stat-value">${statistics.totalSheets || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–û–±—â–æ –¥–µ—Ç–∞–π–ª–∏</div>
                        <div class="stat-value">${statistics.totalParts || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ü–æ—Å—Ç–∞–≤–µ–Ω–∏ –¥–µ—Ç–∞–π–ª–∏</div>
                        <div class="stat-value">${statistics.placedParts || 0} (${statistics.placementRate || '0%'})</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç</div>
                        <div class="stat-value">${statistics.materialEfficiency || '0%'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–°—Ä. –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç –Ω–∞ –ª–∏—Å—Ç</div>
                        <div class="stat-value">${statistics.avgSheetEfficiency || '0%'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª–Ω–∞ —Ü–µ–Ω–∞</div>
                        <div class="stat-value">${statistics.estimatedCost || '0.00 –ª–≤.'}</div>
                    </div>
                `;

                // –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–∞
                if (statistics.totalSheetArea > 0) {
                    const ctx = document.getElementById('materialChart');
                    if (ctx) {
                        if (chartInstance) {
                            chartInstance.destroy();
                        }

                        try {
                            chartInstance = new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['–ò–∑–ø–æ–ª–∑–≤–∞–Ω –º–∞—Ç–µ—Ä–∏–∞–ª', '–û—Ç–ø–∞–¥—ä–∫'],
                                    datasets: [{
                                        data: [
                                            statistics.totalUsedArea || 0,
                                            statistics.totalWasteArea || 0
                                        ],
                                        backgroundColor: ['#4CAF50', '#FF9800'],
                                        borderWidth: 1,
                                        borderColor: '#fff'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'bottom',
                                            labels: {
                                                padding: 20,
                                                font: { size: 12 }
                                            }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const value = context.parsed;
                                                    const percent = (value / statistics.totalSheetArea * 100).toFixed(1);
                                                    return `${(value / 1000000).toFixed(3)} m¬≤ (${percent}%)`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        } catch (chartError) {
                            console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–∞:', chartError);
                        }
                    }
                }
            }
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–µ–Ω –æ—Ç—á–µ—Ç
        function generateDetailedReport(engine) {
            const stats = engine.getStatistics();
            const results = engine.results;

            let report = `<div class="cutlist-report">`;

            // –ó–∞–≥–ª–∞–≤–∏–µ
            report += `<h3>üìä –î–µ—Ç–∞–π–ª–µ–Ω –æ—Ç—á–µ—Ç –∑–∞ —Ä–∞–∑–∫—Ä–æ—è–≤–∞–Ω–µ</h3>`;
            report += `<p><small>–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–æ –Ω–∞: ${new Date().toLocaleString('bg-BG')}</small></p>`;

            // –û–±—â–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            report += `<div class="report-section">
                        <h4>üìà –û–±—â–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h4>
                        <table class="report-table">
                            <tr><td>–û–±—â–æ –¥–µ—Ç–∞–π–ª–∏:</td><td><strong>${stats.totalParts}</strong></td></tr>
                            <tr><td>–£—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç–∞–≤–µ–Ω–∏:</td><td><strong>${stats.placedParts} (${stats.placementRate})</strong></td></tr>
                            <tr><td>–ò–∑–ø–æ–ª–∑–≤–∞–Ω–∏ –ª–∏—Å—Ç–æ–≤–µ:</td><td><strong>${stats.totalSheets}</strong></td></tr>
                            <tr><td>–û–±—â–∞ –ø–ª–æ—â –Ω–∞ –ª–∏—Å—Ç–æ–≤–µ—Ç–µ:</td><td><strong>${(stats.totalSheetArea / 1000000).toFixed(3)} m¬≤</strong></td></tr>
                            <tr><td>–ò–∑–ø–æ–ª–∑–≤–∞–Ω–∞ –ø–ª–æ—â:</td><td><strong>${(stats.totalUsedArea / 1000000).toFixed(3)} m¬≤</strong></td></tr>
                            <tr><td>–û—Ç–ø–∞–¥—ä—á–Ω–∞ –ø–ª–æ—â:</td><td><strong>${(stats.totalWasteArea / 1000000).toFixed(3)} m¬≤</strong></td></tr>
                            <tr><td>–ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞:</td><td><strong>${stats.materialEfficiency}</strong></td></tr>
                            <tr><td>–ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª–Ω–∞ —Ü–µ–Ω–∞ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏—Ç–µ:</td><td><strong>${stats.estimatedCost}</strong></td></tr>
                        </table>
                       </div>`;

            // –î–µ—Ç–∞–π–ª–∏ –ø–æ –ª–∏—Å—Ç–æ–≤–µ
            if (results && results.length > 0) {
                report += `<div class="report-section">
                            <h4>üìã –†–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ª–∏—Å—Ç–æ–≤–µ:</h4>`;

                results.forEach((sheet, index) => {
                    const sheetEfficiency = sheet.efficiency ? sheet.efficiency.toFixed(1) + '%' : '0%';
                    const usedArea = sheet.usedArea ? (sheet.usedArea / 1000000).toFixed(3) : '0';
                    const sheetArea = (sheet.area / 1000000).toFixed(3);
                    const sheetCost = (sheet.cost * (sheet.usedArea / sheet.area)).toFixed(2);

                    report += `<div class="sheet-report">
                                <h5>üìÑ –õ–∏—Å—Ç ${index + 1}: ${sheet.width} √ó ${sheet.height} mm (${sheet.materialType || '–ú–∞—Ç–µ—Ä–∏–∞–ª'})</h5>
                                <table class="sheet-details">
                                    <tr><td>–ë—Ä–æ–π –¥–µ—Ç–∞–π–ª–∏:</td><td>${sheet.placedParts.length} –±—Ä.</td></tr>
                                    <tr><td>–ò–∑–ø–æ–ª–∑–≤–∞–Ω–∞ –ø–ª–æ—â:</td><td>${usedArea} m¬≤</td></tr>
                                    <tr><td>–û–±—â–∞ –ø–ª–æ—â –Ω–∞ –ª–∏—Å—Ç–∞:</td><td>${sheetArea} m¬≤</td></tr>
                                    <tr><td>–ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç:</td><td>${sheetEfficiency}</td></tr>
                                    <tr><td>–¶–µ–Ω–∞ –Ω–∞ —Ç–æ–∑–∏ –ª–∏—Å—Ç:</td><td>${sheetCost} –ª–≤.</td></tr>
                                </table>`;

                    // –î–µ—Ç–∞–π–ª–∏ –∑–∞ –≤—Å–µ–∫–∏ –¥–µ—Ç–∞–π–ª –≤ –ª–∏—Å—Ç–∞
                    if (sheet.placedParts.length > 0) {
                        report += `<div style="margin-top: 10px; font-size: 0.9em;">
                                    <strong>–î–µ—Ç–∞–π–ª–∏ –≤ —Ç–æ–∑–∏ –ª–∏—Å—Ç:</strong>
                                    <ul style="margin: 5px 0; padding-left: 20px;">`;

                        sheet.placedParts.forEach(part => {
                            const rotationText = part.rotated ? ' (–∑–∞–≤—ä—Ä–Ω–∞—Ç)' : '';
                            report += `<li>${part.name}: ${part.placedWidth} √ó ${part.placedHeight} mm${rotationText}</li>`;
                        });

                        report += `</ul></div>`;
                    }

                    report += `</div>`;
                });

                report += `</div>`;
            }

            // –°–ø–∏—Å—ä–∫ –Ω–∞ –≤—Å–∏—á–∫–∏ –¥–µ—Ç–∞–π–ª–∏
            report += `<div class="report-section">
                        <h4>üß© –°–ø–∏—Å—ä–∫ –Ω–∞ –≤—Å–∏—á–∫–∏ –¥–µ—Ç–∞–π–ª–∏:</h4>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">`;

            // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∏
            const groupedParts = {};
            engine.parts.forEach(part => {
                const key = `${part.name}|${part.width}|${part.height}|${part.material}`;
                if (!groupedParts[key]) {
                    groupedParts[key] = {
                        name: part.name,
                        width: part.width,
                        height: part.height,
                        material: part.material,
                        count: 0
                    };
                }
                groupedParts[key].count++;
            });

            // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –≥—Ä—É–ø–∏—Ä–∞–Ω–∏—Ç–µ –¥–µ—Ç–∞–π–ª–∏
            Object.values(groupedParts).forEach(part => {
                report += `<div style="padding: 5px 0; border-bottom: 1px dashed #eee;">
                            <strong>${part.name}</strong> - ${part.width} √ó ${part.height} –º–º (${part.material})
                            <span style="float: right;">–ë—Ä–æ–π: ${part.count}</span>
                           </div>`;
            });

            report += `</div></div>`;

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è—Ç–∞
            report += `<div class="report-section">
                        <h4>‚öôÔ∏è –ò–∑–ø–æ–ª–∑–≤–∞–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</h4>
                        <table class="report-table">
                            <tr><td>–ó–∞–≤—ä—Ä—Ç–∞–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∏:</td><td>${engine.settings.allowRotation ? '–î–ê' : '–ù–ï'}</td></tr>
                            <tr><td>–ú–µ—Ç–æ–¥ –Ω–∞ —Å–æ—Ä—Ç–∏—Ä–∞–Ω–µ:</td><td>${engine.settings.sortingMethod}</td></tr>
                            <tr><td>–î–µ–±–µ–ª–∏–Ω–∞ –Ω–∞ —Ä–µ–∂–µ—â–æ –æ—Å—Ç—Ä–∏–µ:</td><td>${engine.settings.cuttingBladeWidth} –º–º</td></tr>
                            <tr><td>–ú–∏–Ω–∏–º–∞–ª–µ–Ω –æ—Ç–ø–∞–¥—ä–∫:</td><td>${engine.settings.minWasteArea.toLocaleString('bg-BG')} –º–º¬≤</td></tr>
                        </table>
                       </div>`;

            report += `</div>`;

            detailedReport.innerHTML = report;
        }

        // –ü—Ä–µ—Ä–∏—Å—É–≤–∞–Ω–µ –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏—Ç–µ
        function redrawVisualizations() {
            const results = engine.results;
            if (results && results.length > 0) {
                results.forEach((sheet, index) => {
                    const vizElement = document.getElementById(`sheetVisualization${index}`);
                    if (vizElement) {
                        try {
                            const svg = CutListVisualizer.generateSVG(sheet, visualizationOptions);
                            vizElement.innerHTML = svg;
                        } catch (error) {
                            console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—Ä–µ—Ä–∏—Å—É–≤–∞–Ω–µ:', error);
                        }
                    }
                });
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∑–∞ –ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ
        function removePartByKey(key) {
            if (!confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –ø—Ä–µ–º–∞—Ö–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –¥–µ—Ç–∞–π–ª–∏ –æ—Ç —Ç–æ–∑–∏ —Ç–∏–ø?')) return;

            console.log('–ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –¥–µ—Ç–∞–π–ª–∏ —Å –∫–ª—é—á:', key);

            // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –≤—Å–∏—á–∫–∏ –¥–µ—Ç–∞–π–ª–∏ —Å—ä—Å —Å—ä—â–æ—Ç–æ –∏–º–µ –∏ —Ä–∞–∑–º–µ—Ä–∏
            const [name, width, height, material] = key.split('|');

            engine.parts = engine.parts.filter(p =>
                !(p.name === name &&
                  p.width === parseInt(width) &&
                  p.height === parseInt(height) &&
                  p.material === material)
            );

            updatePartsList();
        }

        function removeSheet(sheetId) {
            if (!confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –ø—Ä–µ–º–∞—Ö–Ω–µ—Ç–µ —Ç–æ–∑–∏ –ª–∏—Å—Ç?')) return;

            console.log('–ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –ª–∏—Å—Ç —Å id:', sheetId);
            engine.sheets = engine.sheets.filter(s => s.id !== sheetId);
            updateSheetsList();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            updatePartsList();
            updateSheetsList();
            console.log('Cut-list –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä—ä—Ç –µ –∑–∞—Ä–µ–¥–µ–Ω.');

            // –§–æ–∫—É—Å–∏—Ä–∞–Ω–µ –Ω–∞ –ø—ä—Ä–≤–æ—Ç–æ –ø–æ–ª–µ
            document.getElementById('partName').focus();
        });
    </script>
</body>
</html>
